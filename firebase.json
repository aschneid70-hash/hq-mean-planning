// src/hooks/useFamilyData.js
// Real-time listener on a single shared Firestore document.
// Any device that opens the app sees the same data instantly.

import { useState, useEffect, useRef } from 'react'
import { doc, onSnapshot, setDoc } from 'firebase/firestore'
import { db, FAMILY_DOC_ID } from '../firebase'

const COLLECTION = 'hq-meal-planning'

// Debounce writes so rapid state changes don't hammer Firestore
function useDebounce(fn, delay = 800) {
  const timer = useRef(null)
  return (...args) => {
    clearTimeout(timer.current)
    timer.current = setTimeout(() => fn(...args), delay)
  }
}

export function useFamilyData(unlocked) {
  const [weekPlan,      setWeekPlanLocal]      = useState({})
  const [pantryItems,   setPantryItemsLocal]   = useState([])
  const [groceryList,   setGroceryListLocal]   = useState({})
  const [checkedItems,  setCheckedItemsLocal]  = useState({})
  const [storeRouteInfo,setStoreRouteInfoLocal]= useState(null)
  const [grocerySource, setGrocerySourceLocal] = useState('')
  const [loading,       setLoading]            = useState(true)

  const docRef = doc(db, COLLECTION, FAMILY_DOC_ID)

  // Write helper — merges patch into Firestore doc
  const save = (patch) => setDoc(docRef, patch, { merge: true }).catch(console.error)
  const debouncedSave = useDebounce(save, 600)

  // Real-time listener — only start when app is unlocked
  useEffect(() => {
    if (!unlocked) { setLoading(false); return }
    const unsub = onSnapshot(docRef, (snap) => {
      if (snap.exists()) {
        const d = snap.data()
        setWeekPlanLocal(d.weekPlan       || {})
        setPantryItemsLocal(d.pantryItems || [])
        setGroceryListLocal(d.groceryList || {})
        setCheckedItemsLocal(d.checkedItems || {})
        setStoreRouteInfoLocal(d.storeRouteInfo || null)
        setGrocerySourceLocal(d.grocerySource || '')
      }
      setLoading(false)
    }, (err) => { console.error('Firestore error', err); setLoading(false) })
    return () => unsub()
  }, [unlocked])

  // Setters that update local state + persist to Firestore
  const setWeekPlan = (updater) => {
    setWeekPlanLocal(prev => {
      const next = typeof updater === 'function' ? updater(prev) : updater
      debouncedSave({ weekPlan: next })
      return next
    })
  }
  const setPantryItems = (items) => {
    setPantryItemsLocal(items)
    debouncedSave({ pantryItems: items })
  }
  const setGroceryList = (list) => {
    setGroceryListLocal(list)
    debouncedSave({ groceryList: list })
  }
  const setCheckedItems = (items) => {
    setCheckedItemsLocal(items)
    debouncedSave({ checkedItems: items })
  }
  const setStoreRouteInfo = (info) => {
    setStoreRouteInfoLocal(info)
    debouncedSave({ storeRouteInfo: info })
  }
  const setGrocerySource = (src) => {
    setGrocerySourceLocal(src)
    debouncedSave({ grocerySource: src })
  }

  return {
    weekPlan, setWeekPlan,
    pantryItems, setPantryItems,
    groceryList, setGroceryList,
    checkedItems, setCheckedItems,
    storeRouteInfo, setStoreRouteInfo,
    grocerySource, setGrocerySource,
    loading,
  }
}
